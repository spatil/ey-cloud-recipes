#!/bin/bash
#
# This script starts and stops the ap4r server
# This script belongs in /engineyard/bin/ap4r
#

pushd .

export PATH=/bin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:$PATH
export RAILS_ENV=<%= @rails_env %>

usage() {
  echo "Usage: $0 {start, stop}"
  exit 1
}

if [ $# -lt 1 ]; then usage; fi

if [ -d /data/ap4r ]; then
  cd /data/ap4r
  mkdir -p /var/log/engineyard/ap4r/

  # source a ap4r.conf file if people need to override ENV settings
  if [ -f /data/ap4r/config/ap4r.conf ]; then
    . /data/ap4r/config/ap4r.conf
  fi

  # handle the second param, don't start if already existing
  case "$1" in
    start)
      cd /data/ap4r
      echo "Starting ap4r server."
      if [ -f /data/ap4r/log/ap4r.pid ]; then
        PID=`cat /data/ap4r/log/ap4r.pid`
        if [ ! -d /proc/$PID ]; then
          rm -f /data/ap4r/log/ap4r.pid
        fi
      fi
      nohup /usr/bin/ruby /data/ap4r/script/mongrel_ap4r start -A /data/ap4r/config/queues_disk.cfg -d -l /var/log/engineyard/ap4r.log -P /data/ap4r/log/ap4r.pid -c /data/ap4r
      ;;
    stop)
      echo "Stopping ap4r server."
      if [ -f /data/ap4r/log/ap4r.pid ]; then
        kill -9 `cat /data/ap4r/log/ap4r.pid` 2>/dev/null; true
      fi
      ;;
    *)
      usage
      ;;
	esac
else
  echo "/data/ap4r doesn't exist."
  usage
fi

popd .
