#!/bin/sh
#
# This script starts and stops the rabbitmq server
# This script belongs in /engineyard/bin/rabbitmq
#
PATH=/bin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:$PATH
HOME=/root; export HOME
LOG_FILE=/var/log/rabbitmq/rabbit.log
PID_FILE=/var/run/rabbitmq/rabbitmq.pid

usage() {
  echo "Usage: $0 {start, stop}"
  exit 1
}

if [ $# -lt 1 ]; then usage; fi

mkdir -p /var/log/rabbitmq
mkdir -p /var/run/rabbitmq

# handle the second param, don't start if already existing
case "$1" in
  start)
    echo "Starting the RabbitMQ server."
    if [ -f $PID_FILE ]; then
      PID=`cat $PID_FILE`
      if [ -d /proc/$PID ]; then
        echo "RabbitMQ is already running."
        exit 1
      fi
      rm -f $PID_FILE
    fi
    
    nohup /usr/sbin/rabbitmq-server -detached
    sleep 5
    pgrep -f -n rabbitmq > $PID_FILE
    nohup /usr/sbin/rabbitmqctl start_app
    ;;
  stop)
    echo "Stopping the rabbitmq server."
    if [ -f $PID_FILE ]; then
      kill `cat $PID_FILE` 2>/dev/null; true
    fi
    ;;
  *)
    usage
    ;;
esac