#!/bin/sh
#
# This script starts and stops the integrity thins
# This script belongs in /engineyard/bin/integrity
#
PATH=/bin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:$PATH

usage() {
  echo "Usage: $0 <appname> port {start, stop}"
  exit 1
}

if [ $# -lt 3 ]; then usage; fi
if [ -d /data/$1 ]; then
  cd /data/$1/
  HOME=/home/ey; export HOME
  source ~/.bashrc

  # handle the third param, don't start if already existing
  case "$3" in
    start)
      echo "Starting the Integrity server($1)."
      if [ -f /data/$1/thin.$2.pid ]; then
        PID=`cat /data/$1/thin.$2.pid`
        if [ ! -d /proc/$PID ]; then
          rm -f /data/$1/thin.$2.pid
        fi
      fi
      thin -C thin.yml -p $2 -s 1 -R config.ru start 2>&1
      ;;
    stop)
      echo "Stopping the Integrity server($1)."
      kill -9 `cat /data/$1/thin.$2.pid` 2>/dev/null; true
      ;;
    *)
      usage
      ;;
  esac
else
  echo "/data/$1 doesn't exist."
  usage
fi
