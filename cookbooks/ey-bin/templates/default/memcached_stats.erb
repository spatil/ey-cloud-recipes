#!/usr/bin/env ruby
#
# Adapted from http://barkingiguana.com/2009/03/04/memcache-statistics-from-the-command-line
#

require 'socket'

def get_statistics(machine_name, memcached_port)
  socket = TCPSocket.open(machine_name, memcached_port)
  socket.send("stats\r\n", 0)

  statistics = []
  loop do
    data = socket.recv(4096)
    if !data || data.length == 0
      break
    end
    statistics << data
    if statistics.join.split(/\n/)[-1] =~ /END/
      break
    end
  end
  statistics.join()
rescue
  $stderr.puts "*** Error contacting memcached on #{machine_name}:#{memcached_port}"
  exit 1
end

host_name      = `/usr/bin/hostname`.chop
machine_name   = 'localhost'
memcached_port = (ARGV.length > 0) ? ARGV[0] : '11211'

puts "Memcached statistics for #{host_name} #{machine_name}:#{memcached_port}"
puts get_statistics(machine_name, memcached_port)