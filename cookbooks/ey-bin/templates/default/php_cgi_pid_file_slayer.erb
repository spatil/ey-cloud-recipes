#!/bin/bash
# This should live in /engineyard/bin
# It kills the parent fcgi process and its children for reliable restarts
PID=`/bin/cat $1`
if [ "$PID" != "" ]; then
  CHILDREN=`/bin/ps -ef | /bin/grep php-cgi | /bin/egrep "[^0-9]+[ ]+[0-9]+[ ]+ $PID" | /usr/bin/awk '{print $2}' | /usr/bin/xargs echo`
  /bin/kill -9 $PID
  sleep 1
  echo $PID $CHILDREN
  for i in $CHILDREN; do
    /bin/kill -9 $i
  done
fi
exit 0